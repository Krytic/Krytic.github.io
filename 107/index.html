<html lang="en">
	<head>
		<title>PHYSICS 107 Lab Finder</title>
		<link href="https://jenil.github.io/bulmaswatch/minty/bulmaswatch.min.css" rel="stylesheet" />
		<script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

		<style>
		@import url('https://fonts.googleapis.com/css?family=Alegreya&display=swap');
		.expt-info {
			color: #4464ad;
			font-weight: bold;
		}
		
		.title {
			font-family: 'Alegreya', serif;
		}
		
		.hidden {
			visibility: hidden;
		}
		</style>

		<script>
			$(document).ready(function(){
				function nWeeks(date1, date2) {
					var WEEK = 1000 * 60 * 60 * 24 * 7;

					var date1ms = date1.getTime();
					var date2ms = date2.getTime();

					var diff = Math.abs(date2ms - date1ms);

					return Math.floor(diff / WEEK);
				}
				if(new Date() < new Date("September 21, 2019")) {
					regex = /^([a-z]{2,4}[0-9]{3})$/
					
					$.ajax({
						type: "GET",
						url: "students.csv",
						dataType: "text",
						success: function(data) {processData(data);}
					 });

					 var students = [];
					 function processData(allText) {
						var allTextLines = allText.split(/\r\n|\n/);
						var headers = allTextLines[0].split(',');

						for (var i=1; i<allTextLines.length; i++) {
							var data = allTextLines[i].split(',');
							if (data.length == headers.length) {

								var tarr = {};
								students[data[0]] = {stream: data[1], expt: parseInt(data[2])};
							}
						}
					}
					
					expts = {
					1: {title: "The Use of a Computer Planetarium", demo: "Lerh"},
					2: {title: "Telescopes: Area & Resolution", demo: "Jasmine"},
					3: {title: "Simple Telescopes", demo: "Felicien"},
					4: {title: "Distance Modulus", demo: "Connor"},
					5: {title: "Spectroscopy", demo: "Martin"}
					};
					
					$('#upi').on('input', function() { 
						upi = $("#upi").val();
						console.log(upi)
						if(regex.test(upi)) {
							if(upi in students){
								exptnum = (students[upi]['expt'] + nWeeks(new Date('July 22, 2019'), new Date())) % 6;
								console.log(exptnum);
								
								$("#stream").text(students[upi]['stream'] + " at 1PM"); // get the current value of the input field.
								$("#next-exp").text("#" + (exptnum).toString()); // get the current value of the input field.
								$("#next-exp-title").text(expts[exptnum]['title']);
								$("#next-exp-demo").text(expts[exptnum]['demo']);
								$("#upi-display").text(upi);
								console.log(upi);
								$("#data-table").removeClass("hidden");
								$("#not-in-course").addClass("hidden");
							}
							else {
								// "valid" upi, student not in course
								$("#not-in-course").removeClass("hidden");
							}
						} else if(upi == "") {
							$("#not-in-course").addClass("hidden");
							$("#data-table").addClass("hidden");
						}
					});
				} else {
					$("#main-body").addClass("hidden");
					$("#lab-closed").removeClass("hidden");
					$("#body").removeClass("is-info");
					$("#body").addClass("is-danger");
				}
			});
		</script>
	</head>
	<body>
	<section class="hero is-info is-bold is-fullheight" id="body">
		<div class="hero-body">
			<div class="container">
				<div id="main-body">
					<h1 class="has-text-centered title is-1">PHYSICS 107 Lab Finder</h1>
					<div class="field">
						<div class="control">
							<input class="input is-large" id="upi" type="text" placeholder="enter your upi (sric560 for example)">
						</div>
						<hr />
						
						<div id="not-in-course" class="notification is-danger hidden">
							The UPI you entered is valid, but you don't appear to be in this course! :| Talk to <a href="mailto://sric560@aucklanduni.ac.nz">Sean</a> to get this mess sorted D:
						</div>
						
						<section class="section">
							<div class="columns is-centered">
								<div class="column is-narrow has-text-centered hidden" id="data-table">
									<h3 class="title is-3">Hello <span id="upi-display"></span>!</h3>
									<table class="table">
										<tr><td>Lab Stream</td><td id="stream" class="expt-info"></td></tr>
										<tr><td>Next Experiment</td><td id="next-exp" class="expt-info"></td></tr>
										<tr><td>Experiment Name</td><td id="next-exp-title" class="expt-info"></td></tr>
										<tr><td>Demonstrator</td><td id="next-exp-demo" class="expt-info"></td></tr>
									</table>
								</div>
							</div>
						</section>
					</div>
				</div>
				<div class="hidden" id="lab-closed">
					<h1 class="has-text-centered title is-1">There are no more labs this semester.</h1>
				</div>
			</div>
		</section>
	</body>
</html>
